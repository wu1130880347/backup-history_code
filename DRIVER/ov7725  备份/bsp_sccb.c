#include "bsp_sccb.h"
#include "sys.h"

#define DEV_ADR  ADDR_OV7725 			 /*ï¿½è±¸ï¿½ï¿½Ö·ï¿½ï¿½ï¿½ï¿½*/

/********************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_Configuration
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½SCCBï¿½Ü½ï¿½ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½        
 ********************************************************************/
void SCCB_GPIO_Config(void)
{
   GPIO_InitTypeDef  GPIO_InitStructure; 
  /* SCL(PC6)¡¢SDA(PC7)¹Ü½ÅÅäÖÃ */
  RCC_AHB1PeriphClockCmd(RCC_AHB1Periph_GPIOC, ENABLE);
  GPIO_InitStructure.GPIO_Pin =  GPIO_Pin_6 | GPIO_Pin_7;
  GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;
  GPIO_InitStructure.GPIO_Mode = GPIO_Mode_OUT;  
	GPIO_InitStructure.GPIO_OType = GPIO_OType_OD;
  GPIO_Init(GPIOC, &GPIO_InitStructure);
}

/********************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_delay
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½Ó³ï¿½Ê±ï¿½ï¿½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½        
 ********************************************************************/
static void SCCB_delay(void)
{	
   u16 i = 400;
   while(i) 
   { 
     i--; 
   } 
}

/********************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_Start
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½SCCBï¿½ï¿½Ê¼ï¿½Åºï¿½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½        
 ********************************************************************/
static int SCCB_Start(void)
{
	SDA_H;
	SCL_H;
	SCCB_delay();
	if(!SDA_read)
	return DISABLE;	/* SDAï¿½ï¿½Îªï¿½Íµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ã¦,ï¿½Ë³ï¿½ */
	SDA_L;
	SCCB_delay();
	if(SDA_read) 
	return DISABLE;	/* SDAï¿½ï¿½Îªï¿½ßµï¿½Æ½ï¿½ï¿½ï¿½ï¿½ï¿½ß³ï¿½ï¿½ï¿½,ï¿½Ë³ï¿½ */
	SDA_L;
	SCCB_delay();
	return ENABLE;
}



/********************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_Stop
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½SCCBÍ£Ö¹ï¿½Åºï¿½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½        
 ********************************************************************/
static void SCCB_Stop(void)
{
	SCL_L;
	SCCB_delay();
	SDA_L;
	SCCB_delay();
	SCL_H;
	SCCB_delay();
	SDA_H;
	SCCB_delay();
}



/********************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_Ack
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½SCCBÓ¦ï¿½ï¿½Ê½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½        
 ********************************************************************/
static void SCCB_Ack(void)
{	
	SCL_L;
	SCCB_delay();
	SDA_L;
	SCCB_delay();
	SCL_H;
	SCCB_delay();
	SCL_L;
	SCCB_delay();
}



/********************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_NoAck
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½SCCB ï¿½ï¿½Ó¦ï¿½ï¿½Ê½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½        
 ********************************************************************/
static void SCCB_NoAck(void)
{	
	SCL_L;
	SCCB_delay();
	SDA_H;
	SCCB_delay();
	SCL_H;
	SCCB_delay();
	SCL_L;
	SCCB_delay();
}

/********************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_WaitAck
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½SCCB ï¿½È´ï¿½Ó¦ï¿½ï¿½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Îª:=1ï¿½ï¿½ACK,=0ï¿½ï¿½ACK
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½        
 ********************************************************************/
static int SCCB_WaitAck(void) 	
{
	SCL_L;
	SCCB_delay();
	SDA_H;			
	SCCB_delay();
	SCL_H;
	SCCB_delay();
	if(SDA_read)
	{
      SCL_L;
      return DISABLE;
	}
	SCL_L;
	return ENABLE;
}



 /*******************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_SendByte
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½ï¿½Ý´Ó¸ï¿½Î»ï¿½ï¿½ï¿½ï¿½Î»
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½SendByte: ï¿½ï¿½ï¿½Íµï¿½ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½        
 *********************************************************************/
static void SCCB_SendByte(uint8_t SendByte) 
{
    uint8_t i=8;
    while(i--)
    {
        SCL_L;
        SCCB_delay();
      if(SendByte&0x80)
        SDA_H;  
      else 
        SDA_L;   
        SendByte<<=1;
        SCCB_delay();
		SCL_H;
        SCCB_delay();
    }
    SCL_L;
}




 /******************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_ReceiveByte
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½ï¿½Ý´Ó¸ï¿½Î»ï¿½ï¿½ï¿½ï¿½Î»
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½SCCBï¿½ï¿½ï¿½ß·ï¿½ï¿½Øµï¿½ï¿½ï¿½ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½Ú²ï¿½ï¿½ï¿½ï¿½ï¿½        
 *******************************************************************/
static int SCCB_ReceiveByte(void)  
{ 
    u8 i=8;
    u8 ReceiveByte=0;

    SDA_H;				
    while(i--)
    {
      ReceiveByte<<=1;      
      SCL_L;
      SCCB_delay();
	  SCL_H;
      SCCB_delay();	
      if(SDA_read)
      {
        ReceiveByte|=0x01;
      }
    }
    SCL_L;
    return ReceiveByte;
}





 /*****************************************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_WriteByte
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½Ð´Ò»ï¿½Ö½ï¿½ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½- WriteAddress: ï¿½ï¿½Ð´ï¿½ï¿½ï¿½Ö· 	- SendByte: ï¿½ï¿½Ð´ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½	- DeviceAddress: ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Îª:=1ï¿½É¹ï¿½Ð´ï¿½ï¿½,=0Ê§ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½        
 *****************************************************************************************/           
int SCCB_WriteByte( u16 WriteAddress , u8 SendByte )
{		
    if(!SCCB_Start())
	{
	    return DISABLE;
	}
    SCCB_SendByte( DEV_ADR );                    /* ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö· */
    if( !SCCB_WaitAck() )
	{
		SCCB_Stop(); 
		return DISABLE;
	}
    SCCB_SendByte((uint8_t)(WriteAddress & 0x00FF));   /* ï¿½ï¿½ï¿½Ãµï¿½ï¿½ï¿½Ê¼ï¿½ï¿½Ö· */      
    SCCB_WaitAck();	
    SCCB_SendByte(SendByte);
    SCCB_WaitAck();   
    SCCB_Stop(); 
    return ENABLE;
}

/******************************************************************************************************************
 * ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½SCCB_ReadByte
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½È¡Ò»ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½ï¿½  ï¿½ï¿½- pBuffer: ï¿½ï¿½Å¶ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ 	- length: ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½	- ReadAddress: ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö·		 - DeviceAddress: ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½
 * ï¿½ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Îª:=1ï¿½É¹ï¿½ï¿½ï¿½ï¿½ï¿½,=0Ê§ï¿½ï¿½
 * ×¢ï¿½ï¿½  ï¿½ï¿½ï¿½ï¿½        
 **********************************************************************************************************************/           
int SCCB_ReadByte(u8* pBuffer, u16 length, u8 ReadAddress)
{	
    if(!SCCB_Start())
	{
	    return DISABLE;
	}
    SCCB_SendByte( DEV_ADR );         /* ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö· */
    if( !SCCB_WaitAck() )
	{
		SCCB_Stop(); 
		return DISABLE;
	}
    SCCB_SendByte( ReadAddress );     /* ï¿½ï¿½ï¿½Ãµï¿½ï¿½ï¿½Ê¼ï¿½ï¿½Ö· */      
    SCCB_WaitAck();	
    SCCB_Stop(); 
	
    if(!SCCB_Start())
	{
		return DISABLE;
	}
    SCCB_SendByte( DEV_ADR + 1 );     /* ï¿½ï¿½ï¿½ï¿½ï¿½ï¿½Ö· */ 
    if(!SCCB_WaitAck())
	{
		SCCB_Stop(); 
		return DISABLE;
	}
    while(length)
    {
      *pBuffer = SCCB_ReceiveByte();
      if(length == 1)
	  {
		  SCCB_NoAck();
	  }
      else
	  {
		SCCB_Ack(); 
	  }
      pBuffer++;
      length--;
    }
    SCCB_Stop();
    return ENABLE;
}
